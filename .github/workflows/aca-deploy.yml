name: Deploy PipelinePro to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: Image tag to deploy (defaults to current commit SHA)
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_PREFIX: pipelinepro

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve image tag
        id: tag
        run: |
          TAG_INPUT='${{ github.event.inputs.image_tag }}'
          if [ -n "$TAG_INPUT" ]; then
            echo "tag=$TAG_INPUT" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run database migrations job
        run: |
          az containerapp job start \
            --name "${{ secrets.ACA_MIGRATIONS_JOB_NAME }}" \
            --resource-group "${{ secrets.ACA_RESOURCE_GROUP }}"

      - name: Update pipelinepro-api container app
        run: |
          az containerapp update \
            --name "${{ secrets.ACA_PIPELINEPRO_API_APP_NAME }}" \
            --resource-group "${{ secrets.ACA_RESOURCE_GROUP }}" \
            --image "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ steps.tag.outputs.tag }}"

      - name: Update ekchat-api container app
        run: |
          az containerapp update \
            --name "${{ secrets.ACA_EKCHAT_API_APP_NAME }}" \
            --resource-group "${{ secrets.ACA_RESOURCE_GROUP }}" \
            --image "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ekchat-api:${{ steps.tag.outputs.tag }}"

      - name: Update pipelinepro-web container app
        run: |
          az containerapp update \
            --name "${{ secrets.ACA_PIPELINEPRO_WEB_APP_NAME }}" \
            --resource-group "${{ secrets.ACA_RESOURCE_GROUP }}" \
            --image "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ steps.tag.outputs.tag }}"
